import{r as b,j as e,c as O}from"./index-BUBUI_qf.js";import{O as P}from"./OptionsEditor-BZK2yDr-.js";import{Q as T}from"./QuestionRenderer-DQ7SAmLc.js";const R=({config:t,selectedQuestion:a,onQuestionSelect:n,onPageAdd:r,onPageDelete:s,onQuestionAdd:o})=>{const[h,y]=b.useState(new Set([0])),[x,w]=b.useState(""),N=u=>{const i=new Set(h);i.has(u)?i.delete(u):i.add(u),y(i)},C=u=>u.required?"âœ“":u.show_when||u.conditional?"âš ":"â—‹",_=u=>x?u.filter(i=>i.id.toLowerCase().includes(x.toLowerCase())||i.question.toLowerCase().includes(x.toLowerCase())||i.type.toLowerCase().includes(x.toLowerCase())):u,l=u=>{const i={id:`question_${Date.now()}`,question:"New Question",type:"text_short",required:!1};o(u,i)};return t?e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsx("div",{className:"p-4 border-b border-gray-200",children:e.jsx("input",{type:"text",placeholder:"Search questions...",value:x,onChange:u=>w(u.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4",children:t.pages.map((u,i)=>{const j=_(u.questions),v=h.has(i);return e.jsxs("div",{className:"mb-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("button",{onClick:()=>N(i),className:"flex items-center gap-2 flex-1 text-left font-semibold text-gray-800 hover:text-blue-600",children:[e.jsx("span",{className:"text-xs",children:v?"â–¼":"â–¶"}),e.jsx("span",{children:"ðŸ“„"}),e.jsx("span",{children:u.title}),e.jsxs("span",{className:"text-xs text-gray-500",children:["(",u.questions.length,")"]})]}),t.pages.length>1&&e.jsx("button",{onClick:()=>{confirm(`Delete page "${u.title}"?`)&&s(i)},className:"text-red-600 hover:text-red-800 text-sm px-2",title:"Delete page",children:"âœ•"})]}),v&&e.jsxs("div",{className:"ml-6 space-y-1",children:[j.map(m=>e.jsx("button",{onClick:()=>n(m,i),className:`w-full text-left px-3 py-2 rounded text-sm transition-colors ${a?.id===m.id?"bg-blue-100 text-blue-900 border border-blue-300":"hover:bg-gray-100 text-gray-700"}`,children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-xs mt-0.5",children:C(m)}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"font-medium truncate",children:m.id}),e.jsx("div",{className:"text-xs text-gray-600 truncate",children:m.type})]})]})},m.id)),e.jsx("button",{onClick:()=>l(i),className:"w-full text-left px-3 py-2 text-sm text-blue-600 hover:bg-blue-50 rounded border border-dashed border-blue-300",children:"+ Add Question"})]})]},i)})}),e.jsx("div",{className:"p-4 border-t border-gray-200",children:e.jsx("button",{onClick:r,className:"w-full px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700",children:"+ Add Page"})})]}):e.jsx("div",{className:"p-4",children:e.jsx("p",{className:"text-gray-500",children:"No configuration loaded"})})},q=["equals","not_equals","contains","not_contains","in","not_in","exists","not_exists","greater_than","less_than"],$=({conditional:t,config:a,onChange:n})=>{const[r,s]=b.useState(!!t),[o,h]=b.useState(!!t&&(!!t.and||!!t.or)),y=()=>{if(!a)return[];const i=[];return a.pages.forEach(j=>{j.questions.forEach(v=>{i.push(v.id)})}),i.sort()},x=()=>{r?(n(void 0),s(!1)):(n({question_id:"",operator:"equals",value:""}),s(!0))},w=(i,j)=>{t&&n({...t,[i]:j})},N=()=>{t&&(o?(n({question_id:"",operator:"equals",value:""}),h(!1)):(n({and:[{question_id:t.question_id||"",operator:t.operator||"equals",value:t.value||""},{question_id:"",operator:"equals",value:""}]}),h(!0)))},C=i=>{if(!t)return;const j=t[i]||[];n({...t,[i]:[...j,{question_id:"",operator:"equals",value:""}]})},_=(i,j)=>{if(!t)return;const m=(t[i]||[]).filter((g,E)=>E!==j);if(m.length===0){const{[i]:g,...E}=t;n(E)}else n({...t,[i]:m})},l=(i,j,v,m)=>{if(!t)return;const E=[...t[i]||[]];E[j]={...E[j],[v]:m},n({...t,[i]:E})},u=y();if(!r)return e.jsx("div",{className:"bg-gray-50 border border-gray-200 rounded-md p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("p",{className:"text-sm text-gray-600",children:"This question is always shown (no conditions)"}),e.jsx("button",{type:"button",onClick:x,className:"px-3 py-1.5 text-sm bg-blue-600 text-white rounded hover:bg-blue-700",children:"Add Condition"})]})});if(o){const i=t?.and?"and":"or",j=t?.[i]||[];return e.jsxs("div",{className:"bg-gray-50 border border-gray-200 rounded-md p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-sm font-medium text-gray-700",children:["Show when ",i.toUpperCase()," of these conditions are met:"]}),e.jsxs("button",{type:"button",onClick:()=>{if(!t)return;const v=j;n({[i==="and"?"or":"and"]:v})},className:"text-xs text-blue-600 hover:text-blue-800 underline",children:["Switch to ",i==="and"?"OR":"AND"]})]}),e.jsx("button",{type:"button",onClick:x,className:"text-xs text-red-600 hover:text-red-800",children:"Remove All"})]}),e.jsxs("div",{className:"space-y-3",children:[j.map((v,m)=>e.jsx("div",{className:"bg-white border border-gray-300 rounded-md p-3",children:e.jsxs("div",{className:"grid grid-cols-12 gap-2",children:[e.jsxs("div",{className:"col-span-4",children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Question ID"}),e.jsxs("select",{value:v.question_id||"",onChange:g=>l(i,m,"question_id",g.target.value),className:"w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500",children:[e.jsx("option",{value:"",children:"Select..."}),u.map(g=>e.jsx("option",{value:g,children:g},g))]})]}),e.jsxs("div",{className:"col-span-3",children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Operator"}),e.jsx("select",{value:v.operator||"equals",onChange:g=>l(i,m,"operator",g.target.value),className:"w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500",children:q.map(g=>e.jsx("option",{value:g,children:g},g))})]}),e.jsxs("div",{className:"col-span-4",children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Value"}),e.jsx("input",{type:"text",value:v.value||"",onChange:g=>l(i,m,"value",g.target.value),className:"w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500",placeholder:"Expected value..."})]}),e.jsx("div",{className:"col-span-1 flex items-end",children:e.jsx("button",{type:"button",onClick:()=>_(i,m),className:"text-red-600 hover:text-red-800 text-sm px-2 py-1",title:"Remove condition",children:"âœ•"})})]})},m)),e.jsx("button",{type:"button",onClick:()=>C(i),className:"w-full px-3 py-2 text-sm text-blue-600 bg-blue-50 border border-dashed border-blue-300 rounded hover:bg-blue-100",children:"+ Add Condition"})]}),e.jsx("div",{className:"mt-3 pt-3 border-t border-gray-200",children:e.jsx("button",{type:"button",onClick:N,className:"text-xs text-gray-600 hover:text-gray-800 underline",children:"Switch to simple mode"})})]})}return e.jsxs("div",{className:"bg-gray-50 border border-gray-200 rounded-md p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Show when:"}),e.jsx("button",{type:"button",onClick:x,className:"text-xs text-red-600 hover:text-red-800",children:"Remove Condition"})]}),e.jsxs("div",{className:"grid grid-cols-12 gap-3",children:[e.jsxs("div",{className:"col-span-4",children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Question ID"}),e.jsxs("select",{value:t?.question_id||"",onChange:i=>w("question_id",i.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500",children:[e.jsx("option",{value:"",children:"Select..."}),u.map(i=>e.jsx("option",{value:i,children:i},i))]})]}),e.jsxs("div",{className:"col-span-3",children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Operator"}),e.jsx("select",{value:t?.operator||"equals",onChange:i=>w("operator",i.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500",children:q.map(i=>e.jsx("option",{value:i,children:i},i))})]}),e.jsxs("div",{className:"col-span-5",children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Value"}),e.jsx("input",{type:"text",value:t?.value||"",onChange:i=>w("value",i.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500",placeholder:"Expected value..."})]})]}),e.jsx("div",{className:"mt-3 pt-3 border-t border-gray-200",children:e.jsx("button",{type:"button",onClick:N,className:"text-xs text-blue-600 hover:text-blue-800 underline",children:"Add multiple conditions (AND/OR)"})})]})},A=["text_short","text_long","textarea","number","single_select","multi_select","boolean","datetime","datetime_range","cve","cve_input","internet_asset","file_upload","scale"],L=({question:t,config:a,onUpdate:n,onDelete:r})=>{const[s,o]=b.useState(null),[h,y]=b.useState(!1);if(b.useEffect(()=>{o(t?{...t}:null),y(!1)},[t]),!s)return e.jsx("div",{className:"flex items-center justify-center h-full text-gray-500",children:e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-lg mb-2",children:"No question selected"}),e.jsx("p",{className:"text-sm",children:"Select a question from the browser or create a new one"})]})});const x=(l,u)=>{o({...s,[l]:u}),y(!0)},w=()=>{n(s),y(!1)},N=()=>{o(t?{...t}:null),y(!1)},C=()=>{const l={...s,id:`${s.id}_copy_${Date.now()}`};n(l)},_=s.type==="single_select"||s.type==="multi_select"||s.type==="scale";return e.jsx("div",{className:"max-w-4xl mx-auto",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6 pb-4 border-b border-gray-200",children:[e.jsx("h2",{className:"text-xl font-bold text-gray-900",children:"Edit Question"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:C,className:"px-3 py-1.5 text-sm bg-gray-100 text-gray-700 rounded hover:bg-gray-200",title:"Duplicate this question",children:"Duplicate"}),e.jsx("button",{onClick:()=>{confirm("Are you sure you want to delete this question?")&&r()},className:"px-3 py-1.5 text-sm bg-red-100 text-red-700 rounded hover:bg-red-200",children:"Delete"})]})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Question ID ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"text",value:s.id,onChange:l=>x("id",l.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"e.g., incident_reference"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Unique identifier for this question (used in conditional logic)"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Question Text ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("textarea",{value:s.question,onChange:l=>x("question",l.target.value),rows:3,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"What information are you collecting?"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Question Type ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("select",{value:s.type,onChange:l=>x("type",l.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",children:A.map(l=>e.jsx("option",{value:l,children:l},l))}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Determines how the question will be displayed to users"})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",id:"required",checked:s.required||!1,onChange:l=>x("required",l.target.checked),className:"h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"}),e.jsx("label",{htmlFor:"required",className:"ml-2 text-sm font-medium text-gray-700",children:"Required field (users must answer this question)"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Placeholder Text"}),e.jsx("input",{type:"text",value:s.placeholder||"",onChange:l=>x("placeholder",l.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"e.g., Enter incident number..."}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Hint text shown in the input field"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Explanation / Help Text"}),e.jsx("textarea",{value:s.explanation||"",onChange:l=>x("explanation",l.target.value),rows:3,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"Provide additional context or instructions for this question..."}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Detailed help text shown below the question"})]}),_&&e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Options ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx(P,{options:s.options||[],onChange:l=>x("options",l)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Conditional Logic"}),e.jsx($,{conditional:s.show_when||s.conditional,config:a,onChange:l=>x("show_when",l)}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"This question will only be shown when the specified conditions are met"})]})]}),e.jsxs("div",{className:"flex gap-3 mt-8 pt-6 border-t border-gray-200",children:[e.jsx("button",{onClick:w,disabled:!h,className:`flex-1 px-4 py-2 rounded font-medium ${h?"bg-blue-600 text-white hover:bg-blue-700":"bg-gray-200 text-gray-500 cursor-not-allowed"}`,children:"Save Changes"}),h&&e.jsx("button",{onClick:N,className:"px-4 py-2 bg-gray-100 text-gray-700 rounded hover:bg-gray-200",children:"Cancel"})]})]})})},M=({question:t})=>{const[a,n]=b.useState("");return t?e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"mb-4 pb-4 border-b border-gray-200",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-700 mb-1",children:"Live Preview"}),e.jsx("p",{className:"text-xs text-gray-500",children:"This is how the question will appear to users"})]}),e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-6 shadow-sm",children:[e.jsxs("div",{className:"mb-4",children:[e.jsxs("label",{className:"block text-base font-medium text-gray-900 mb-2",children:[t.question,t.required&&e.jsx("span",{className:"text-red-500 ml-1",children:"*"})]}),t.explanation&&e.jsx("p",{className:"text-sm text-gray-600 mb-3 leading-relaxed",children:t.explanation}),(t.show_when||t.conditional)&&e.jsx("div",{className:"mb-3 p-2 bg-amber-50 border border-amber-200 rounded text-xs text-amber-800",children:"âš  This question has conditional logic and may not always be visible"}),e.jsx(T,{question:t,value:a,onChange:n,showHint:!0})]}),e.jsx("div",{className:"mt-4 pt-4 border-t border-gray-200",children:e.jsx("button",{onClick:()=>n(""),className:"text-xs text-gray-600 hover:text-gray-800 underline",children:"Reset Preview"})})]}),e.jsx("div",{className:"mt-6 space-y-3",children:e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[e.jsx("h4",{className:"text-xs font-semibold text-gray-700 mb-3",children:"Question Details"}),e.jsxs("dl",{className:"space-y-2 text-xs",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("dt",{className:"text-gray-600",children:"ID:"}),e.jsx("dd",{className:"font-mono text-gray-900",children:t.id})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("dt",{className:"text-gray-600",children:"Type:"}),e.jsx("dd",{className:"font-mono text-gray-900",children:t.type})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("dt",{className:"text-gray-600",children:"Required:"}),e.jsx("dd",{className:"font-mono text-gray-900",children:t.required?"Yes":"No"})]}),t.options&&t.options.length>0&&e.jsxs("div",{children:[e.jsx("dt",{className:"text-gray-600 mb-1",children:"Options:"}),e.jsx("dd",{className:"font-mono text-gray-900 ml-2",children:e.jsx("ul",{className:"list-disc list-inside",children:t.options.map((r,s)=>e.jsx("li",{children:r.label||r.value},s))})})]}),(t.show_when||t.conditional)&&e.jsxs("div",{children:[e.jsx("dt",{className:"text-gray-600 mb-1",children:"Conditional Logic:"}),e.jsx("dd",{className:"font-mono text-xs text-gray-900 bg-gray-100 p-2 rounded overflow-x-auto",children:e.jsx("pre",{children:JSON.stringify(t.show_when||t.conditional,null,2)})})]})]})]})})]}):e.jsx("div",{className:"p-6",children:e.jsxs("div",{className:"text-center text-gray-500",children:[e.jsx("p",{className:"text-sm",children:"No question selected"}),e.jsx("p",{className:"text-xs mt-2",children:"Select a question to see how it will appear to users"})]})})},V=({errors:t,onQuestionClick:a})=>{const n=t.filter(s=>s.type==="error"),r=t.filter(s=>s.type==="warning");return t.length===0?e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-green-600 text-xl",children:"âœ“"}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-semibold text-green-800",children:"Configuration Valid"}),e.jsx("p",{className:"text-xs text-green-700 mt-1",children:"No errors or warnings found. Ready to download!"})]})]})}):e.jsxs("div",{className:"space-y-3",children:[n.length>0&&e.jsxs("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:[e.jsxs("h3",{className:"text-sm font-semibold text-red-800 mb-3 flex items-center gap-2",children:[e.jsx("span",{children:"âŒ"}),n.length," Error",n.length>1?"s":""," (Must Fix)"]}),e.jsx("div",{className:"space-y-2",children:n.map((s,o)=>e.jsx("div",{className:"bg-white border border-red-200 rounded p-3 text-sm",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1",children:[s.questionId&&e.jsxs("div",{className:"font-mono text-xs text-red-700 mb-1",children:[s.questionId,s.pageIndex!==void 0&&e.jsxs("span",{className:"text-red-500",children:[" (Page ",s.pageIndex+1,")"]})]}),e.jsx("p",{className:"text-red-900",children:s.message}),s.field&&e.jsxs("p",{className:"text-xs text-red-600 mt-1",children:["Field: ",s.field]})]}),s.questionId&&s.pageIndex!==void 0&&a&&e.jsx("button",{onClick:()=>a(s.questionId,s.pageIndex),className:"text-xs text-red-600 hover:text-red-800 underline ml-3",children:"Jump to"})]})},o))})]}),r.length>0&&e.jsxs("div",{className:"bg-amber-50 border border-amber-200 rounded-lg p-4",children:[e.jsxs("h3",{className:"text-sm font-semibold text-amber-800 mb-3 flex items-center gap-2",children:[e.jsx("span",{children:"âš "}),r.length," Warning",r.length>1?"s":""]}),e.jsx("div",{className:"space-y-2",children:r.map((s,o)=>e.jsx("div",{className:"bg-white border border-amber-200 rounded p-3 text-sm",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1",children:[s.questionId&&e.jsxs("div",{className:"font-mono text-xs text-amber-700 mb-1",children:[s.questionId,s.pageIndex!==void 0&&e.jsxs("span",{className:"text-amber-500",children:[" (Page ",s.pageIndex+1,")"]})]}),e.jsx("p",{className:"text-amber-900",children:s.message}),s.field&&e.jsxs("p",{className:"text-xs text-amber-600 mt-1",children:["Field: ",s.field]})]}),s.questionId&&s.pageIndex!==void 0&&a&&e.jsx("button",{onClick:()=>a(s.questionId,s.pageIndex),className:"text-xs text-amber-600 hover:text-amber-800 underline ml-3",children:"Jump to"})]})},o))}),e.jsx("p",{className:"text-xs text-amber-700 mt-3",children:"These are suggestions and won't prevent downloading, but may indicate potential issues."})]})]})},U=["text","text_short","text_long","textarea","number","single_select","multi_select","boolean","cve","cve_input","datetime","datetime_range","internet_asset","file_upload","scale"];class F{config;errors=[];questionIdMap=new Map;constructor(a){this.config=a,this.buildQuestionIdMap()}buildQuestionIdMap(){this.config.pages.forEach((a,n)=>{a.questions.forEach(r=>{this.questionIdMap.set(r.id,{pageIndex:n,question:r})})})}validate(){return this.errors=[],this.validateQuestionIds(),this.validateQuestionFields(),this.validateQuestionTypes(),this.validateOptions(),this.validateConditionalLogic(),this.validateCircularDependencies(),this.validateOrphanedQuestions(),this.errors}validateQuestionIds(){const a=new Map;this.config.pages.forEach((n,r)=>{n.questions.forEach(s=>{(!s.id||s.id.trim()==="")&&this.errors.push({type:"error",questionId:s.id,pageIndex:r,message:"Question ID cannot be empty",field:"id"});const o=a.get(s.id)||0;a.set(s.id,o+1)})}),a.forEach((n,r)=>{n>1&&this.errors.push({type:"error",questionId:r,message:`Duplicate question ID "${r}" found ${n} times`,field:"id"})})}validateQuestionFields(){this.config.pages.forEach((a,n)=>{a.questions.forEach(r=>{(!r.question||r.question.trim()==="")&&this.errors.push({type:"error",questionId:r.id,pageIndex:n,message:"Question text cannot be empty",field:"question"}),r.type||this.errors.push({type:"error",questionId:r.id,pageIndex:n,message:"Question type is required",field:"type"})})})}validateQuestionTypes(){this.config.pages.forEach((a,n)=>{a.questions.forEach(r=>{U.includes(r.type)||this.errors.push({type:"error",questionId:r.id,pageIndex:n,message:`Invalid question type "${r.type}"`,field:"type"})})})}validateOptions(){this.config.pages.forEach((a,n)=>{a.questions.forEach(r=>{["single_select","multi_select","scale"].includes(r.type)&&(!r.options||r.options.length===0?this.errors.push({type:"error",questionId:r.id,pageIndex:n,message:`Question type "${r.type}" requires at least one option`,field:"options"}):r.options.forEach((o,h)=>{(!o.value||o.value.trim()==="")&&this.errors.push({type:"error",questionId:r.id,pageIndex:n,message:`Option ${h+1} must have a value`,field:"options"}),(!o.label||o.label.trim()==="")&&this.errors.push({type:"warning",questionId:r.id,pageIndex:n,message:`Option ${h+1} is missing a label`,field:"options"})}))})})}validateConditionalLogic(){this.config.pages.forEach((a,n)=>{a.questions.forEach(r=>{const s=r.show_when||r.conditional;s&&this.validateConditional(s,r.id,n)})})}validateConditional(a,n,r){if(a.and)a.and.forEach(s=>{this.validateConditional(s,n,r)});else if(a.or)a.or.forEach(s=>{this.validateConditional(s,n,r)});else{const s=a.question_id||a.question;if(!s){this.errors.push({type:"error",questionId:n,pageIndex:r,message:"Conditional logic is missing question_id",field:"show_when"});return}this.questionIdMap.has(s)||this.errors.push({type:"error",questionId:n,pageIndex:r,message:`Referenced question "${s}" does not exist`,field:"show_when"}),s===n&&this.errors.push({type:"error",questionId:n,pageIndex:r,message:"Question cannot reference itself in conditional logic",field:"show_when"})}}validateCircularDependencies(){const a=new Set,n=new Set,r=(s,o)=>{if(n.has(s)){const y=o.indexOf(s),x=[...o.slice(y),s];return this.errors.push({type:"warning",questionId:s,message:`Circular dependency detected: ${x.join(" â†’ ")}`,field:"show_when"}),!0}if(a.has(s))return!1;a.add(s),n.add(s);const h=this.questionIdMap.get(s);if(h){const y=h.question.show_when||h.question.conditional;if(y){const x=this.extractDependencies(y);for(const w of x)if(r(w,[...o,s]))return!0}}return n.delete(s),!1};this.questionIdMap.forEach((s,o)=>{a.has(o)||r(o,[])})}extractDependencies(a){const n=[];if(a.and)a.and.forEach(r=>{n.push(...this.extractDependencies(r))});else if(a.or)a.or.forEach(r=>{n.push(...this.extractDependencies(r))});else{const r=a.question_id||a.question;r&&n.push(r)}return n}validateOrphanedQuestions(){this.config.pages.forEach((a,n)=>{a.questions.forEach(r=>{const s=r.show_when||r.conditional;s&&this.checkIfOrphaned(s,new Set)&&this.errors.push({type:"warning",questionId:r.id,pageIndex:n,message:"This question may be unreachable due to impossible conditions",field:"show_when"})})})}checkIfOrphaned(a,n){if(a.and)return a.and.some(h=>this.checkIfOrphaned(h,n));if(a.or)return a.or.every(h=>this.checkIfOrphaned(h,n));const r=a.question_id||a.question;if(!r||n.has(r))return!1;n.add(r);const s=this.questionIdMap.get(r);if(!s)return!0;const o=s.question.show_when||s.question.conditional;return o?this.checkIfOrphaned(o,n):!1}getBlockingErrors(){return this.errors.filter(a=>a.type==="error")}getWarnings(){return this.errors.filter(a=>a.type==="warning")}hasBlockingErrors(){return this.getBlockingErrors().length>0}}function S(t){return new F(t).validate()}function Q(t){return t.some(a=>a.type==="error")}const B=()=>{const[t,a]=b.useState(null),[n,r]=b.useState(null),[s,o]=b.useState(null),[h,y]=b.useState(!0),[x,w]=b.useState(null),[N,C]=b.useState([]),[_,l]=b.useState(!1);b.useEffect(()=>{(async()=>{try{const f=await fetch("/ikb-demo/data/phase1-config.json");if(!f.ok)throw new Error("Failed to load configuration");const p=await f.json();a(p),y(!1)}catch(d){w(d instanceof Error?d.message:"Unknown error"),y(!1)}})()},[]),b.useEffect(()=>{if(t){const c=S(t);C(c)}},[t]);const u=(c,d)=>{r(c),o(d)},i=c=>{if(!t||s===null)return;const d={...t},f=d.pages[s].questions,p=f.findIndex(k=>k.id===n?.id);p!==-1&&(f[p]=c,a(d),r(c))},j=(c,d)=>{if(!t)return;const f={...t};f.pages[c].questions.push(d),a(f),r(d),o(c)},v=()=>{if(!t||s===null||!n)return;const c={...t},d=c.pages[s].questions,f=d.findIndex(p=>p.id===n.id);f!==-1&&(d.splice(f,1),a(c),r(null))},m=()=>{if(!t)return;const c={id:`page_${Date.now()}`,title:`New Page ${t.pages.length+1}`,questions:[]},d={...t};d.pages.push(c),a(d)},g=c=>{if(!t)return;const d={...t};d.pages.splice(c,1),a(d),s===c&&(r(null),o(null))},E=()=>{if(!t)return;const c=S(t);if(C(c),Q(c)){l(!0),alert("Cannot export: Please fix all errors before downloading the configuration.");return}if(c.length>0&&!confirm(`There are ${c.length} warning(s) in your configuration. Do you want to continue with the download?`)){l(!0);return}const d=new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),f=URL.createObjectURL(d),p=document.createElement("a");p.href=f,p.download="phase1-config.json",document.body.appendChild(p),p.click(),document.body.removeChild(p),URL.revokeObjectURL(f)},I=async c=>{try{const d=await c.text(),f=JSON.parse(d),p=S(f);if(C(p),Q(p)&&!confirm(`The imported configuration has ${p.filter(D=>D.type==="error").length} error(s). Import anyway?`)){l(!0);return}a(f),r(null),o(null),l(!0)}catch(d){alert("Failed to import configuration: "+(d instanceof Error?d.message:"Unknown error"))}};return h?e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"Loading configuration..."})]})}):x?e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsxs("p",{className:"text-red-600 mb-4",children:["Error: ",x]}),e.jsx("button",{onClick:()=>window.location.reload(),className:"px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700",children:"Retry"})]})}):e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[e.jsx("header",{className:"bg-white shadow-sm border-b border-gray-200",children:e.jsx("div",{className:"max-w-full mx-auto px-4 py-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Question Editor"}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:"Phase 1 Configuration"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{onClick:()=>l(!_),className:`px-4 py-2 rounded border ${Q(N)?"bg-red-50 text-red-700 border-red-300":N.length>0?"bg-amber-50 text-amber-700 border-amber-300":"bg-green-50 text-green-700 border-green-300"}`,children:Q(N)?e.jsxs("span",{children:["âŒ ",N.filter(c=>c.type==="error").length," Errors"]}):N.length>0?e.jsxs("span",{children:["âš  ",N.length," Warnings"]}):e.jsx("span",{children:"âœ“ Valid"})}),e.jsxs("label",{className:"px-4 py-2 bg-white text-blue-600 border border-blue-600 rounded hover:bg-blue-50 cursor-pointer",children:["Import Config",e.jsx("input",{type:"file",accept:".json",className:"hidden",onChange:c=>{const d=c.target.files?.[0];d&&I(d)}})]}),e.jsx("button",{onClick:E,className:"px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700",children:"Download Configuration"})]})]})})}),_&&e.jsx("div",{className:"bg-gray-100 border-b border-gray-200 p-4",children:e.jsx("div",{className:"max-w-full mx-auto",children:e.jsx(V,{errors:N,onQuestionClick:(c,d)=>{const p=t?.pages[d]?.questions.find(k=>k.id===c);p&&(u(p,d),l(!1))}})})}),e.jsxs("div",{className:"flex h-[calc(100vh-88px)]",children:[e.jsx("div",{className:"w-1/4 bg-white border-r border-gray-200 overflow-y-auto",children:e.jsx(R,{config:t,selectedQuestion:n,onQuestionSelect:u,onPageAdd:m,onPageDelete:g,onQuestionAdd:j})}),e.jsx("div",{className:"w-1/2 overflow-y-auto p-6",children:e.jsx(L,{question:n,config:t,onUpdate:i,onDelete:v})}),e.jsx("div",{className:"w-1/4 bg-white border-l border-gray-200 overflow-y-auto",children:e.jsx(M,{question:n})})]})]})};O.createRoot(document.getElementById("editor-root")).render(e.jsx(b.StrictMode,{children:e.jsx(B,{})}));
