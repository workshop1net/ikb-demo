import{r as m,j as e,c as L}from"./index-BUBUI_qf.js";import{O}from"./OptionsEditor-BZK2yDr-.js";import{M as D}from"./mitreDataLoader-y46ETTK4.js";const R=({config:n,mitreData:h,selectedGroup:i,onGroupSelect:b,onGroupAdd:t})=>{const[r,x]=m.useState(""),[l,j]=m.useState("all"),[p,_]=m.useState("technique"),S=m.useMemo(()=>{if(!n)return[];const c=new Set;return n.question_groups.forEach(g=>{g.tactic_id&&c.add(g.tactic_id)}),Array.from(c).sort()},[n]),o=m.useMemo(()=>{if(!n)return[];let c=n.question_groups;if(r){const g=r.toLowerCase();c=c.filter(w=>{const N=w.technique_id?.toLowerCase().includes(g),d=w.tactic_id?.toLowerCase().includes(g),s=w.id?.toLowerCase().includes(g),a=h?.techniques[w.technique_id]?.name?.toLowerCase().includes(g),u=h?.tactics[w.tactic_id]?.name?.toLowerCase().includes(g);return N||d||s||a||u})}return l!=="all"&&(c=c.filter(g=>g.tactic_id===l)),c=[...c].sort((g,w)=>p==="technique"?(g.technique_id||"").localeCompare(w.technique_id||""):p==="tactic"?(g.tactic_id||"").localeCompare(w.tactic_id||""):(g.id||"").localeCompare(w.id||"")),c.map(g=>({group:g,originalIndex:n.question_groups.indexOf(g)}))},[n,r,l,p,h]),f=()=>{const c={id:`group_${Date.now()}`,technique_id:"",tactic_id:"",show_when:{trigger_type:"technique_tactic_selected",technique_tactic_combinations:[]},question_flow:[]};t(c)},v=c=>h?.techniques[c]?.name||c,y=c=>h?.tactics[c]?.name||c;return e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsxs("div",{className:"p-4 border-b border-gray-200 bg-gray-50",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Question Groups"}),e.jsx("button",{onClick:f,className:"px-3 py-1.5 text-sm bg-blue-600 text-white rounded hover:bg-blue-700",title:"Add new question group",children:"+ New Group"})]}),e.jsx("input",{type:"text",placeholder:"Search technique, tactic, or ID...",value:r,onChange:c=>x(c.target.value),className:"w-full px-3 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 mb-2"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("select",{value:l,onChange:c=>j(c.target.value),className:"flex-1 px-2 py-1.5 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"all",children:"All Tactics"}),S.map(c=>e.jsx("option",{value:c,children:y(c)},c))]}),e.jsxs("select",{value:p,onChange:c=>_(c.target.value),className:"px-2 py-1.5 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"technique",children:"Sort by Technique"}),e.jsx("option",{value:"tactic",children:"Sort by Tactic"}),e.jsx("option",{value:"id",children:"Sort by ID"})]})]}),e.jsxs("div",{className:"text-xs text-gray-500 mt-2",children:["Showing ",o.length," of ",n?.question_groups.length||0," groups"]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:o.length===0?e.jsx("div",{className:"p-4 text-center text-gray-500 text-sm",children:r||l!=="all"?e.jsx("p",{children:"No groups match your filters"}):e.jsx("p",{children:'No question groups yet. Click "New Group" to add one.'})}):e.jsx("div",{className:"divide-y divide-gray-200",children:o.map(({group:c,originalIndex:g})=>{const w=i?.id===c.id,N=c.question_flow?.length||0;return e.jsxs("div",{onClick:()=>b(c,g),className:`p-3 cursor-pointer transition-colors ${w?"bg-blue-50 border-l-4 border-blue-600":"hover:bg-gray-50 border-l-4 border-transparent"}`,children:[e.jsx("div",{className:"flex items-start justify-between mb-1",children:e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900 truncate",children:c.technique_id||"No Technique"}),e.jsx("div",{className:"text-xs text-gray-600 truncate",children:v(c.technique_id)})]})}),e.jsxs("div",{className:"flex items-center gap-2 mt-2",children:[e.jsx("span",{className:"inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-800",children:c.tactic_id||"No Tactic"}),e.jsxs("span",{className:"text-xs text-gray-500",children:[N," question",N!==1?"s":""]})]}),!c.technique_id||!c.tactic_id?e.jsx("div",{className:"mt-2 text-xs text-red-600",children:"⚠ Missing technique or tactic"}):null]},c.id)})})})]})},U=({techniqueId:n,tacticId:h,mitreData:i,onTechniqueChange:b,onTacticChange:t})=>{const[r,x]=m.useState(""),[l,j]=m.useState(!1),[p,_]=m.useState(""),[S,o]=m.useState(!1),f=m.useMemo(()=>i?Object.entries(i.techniques).map(([s,a])=>({id:s,name:a.name,tactics:a.tactics||[]})).sort((s,a)=>s.id.localeCompare(a.id)):[],[i]),v=m.useMemo(()=>{if(!r)return f;const s=r.toLowerCase();return f.filter(a=>a.id.toLowerCase().includes(s)||a.name.toLowerCase().includes(s))},[f,r]),y=m.useMemo(()=>i?Object.entries(i.tactics).map(([s,a])=>({id:s,name:a.name})).sort((s,a)=>{const u=i.tacticOrder?.indexOf(s.id)??999,q=i.tacticOrder?.indexOf(a.id)??999;return u-q}):[],[i]),c=m.useMemo(()=>{if(!p)return y;const s=p.toLowerCase();return y.filter(a=>a.id.toLowerCase().includes(s)||a.name.toLowerCase().includes(s))},[y,p]),g=m.useMemo(()=>{if(!n||!i)return y;const s=i.techniques[n];return!s||!s.tactics?y:y.filter(a=>s.tactics?.includes(a.id))},[n,i,y]),w=m.useMemo(()=>{if(!n||!h||!i)return!0;const s=i.techniques[n];return s?s.tactics?.includes(h)??!1:!1},[n,h,i]),N=i?.techniques[n],d=i?.tactics[h];return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Technique ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"text",value:n,onChange:s=>{b(s.target.value),x(s.target.value),j(!0)},onFocus:()=>j(!0),placeholder:"Search technique ID or name...",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"}),N&&e.jsx("div",{className:"mt-1 text-sm text-gray-600",children:N.name}),l&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 z-10",onClick:()=>j(!1)}),e.jsxs("div",{className:"absolute z-20 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto",children:[e.jsx("div",{className:"p-2 border-b border-gray-200",children:e.jsx("input",{type:"text",value:r,onChange:s=>x(s.target.value),placeholder:"Filter techniques...",className:"w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500",onClick:s=>s.stopPropagation()})}),e.jsx("div",{className:"max-h-48 overflow-y-auto",children:v.length===0?e.jsx("div",{className:"px-3 py-2 text-sm text-gray-500",children:"No techniques found"}):v.map(s=>e.jsxs("div",{onClick:()=>{b(s.id),x(""),j(!1)},className:"px-3 py-2 cursor-pointer hover:bg-blue-50 border-b border-gray-100",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900",children:s.id}),e.jsx("div",{className:"text-xs text-gray-600",children:s.name}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:[s.tactics.length," tactic",s.tactics.length!==1?"s":""]})]},s.id))})]})]})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Tactic ",e.jsx("span",{className:"text-red-500",children:"*"}),n&&g.length<y.length&&e.jsxs("span",{className:"ml-2 text-xs text-blue-600",children:["(Showing ",g.length," valid tactics for ",n,")"]})]}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"text",value:h,onChange:s=>{t(s.target.value),_(s.target.value),o(!0)},onFocus:()=>o(!0),placeholder:"Search tactic ID or name...",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"}),d&&e.jsx("div",{className:"mt-1 text-sm text-gray-600",children:d.name}),S&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 z-10",onClick:()=>o(!1)}),e.jsxs("div",{className:"absolute z-20 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto",children:[e.jsx("div",{className:"p-2 border-b border-gray-200",children:e.jsx("input",{type:"text",value:p,onChange:s=>_(s.target.value),placeholder:"Filter tactics...",className:"w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500",onClick:s=>s.stopPropagation()})}),e.jsx("div",{className:"max-h-48 overflow-y-auto",children:(n?g:c).length===0?e.jsx("div",{className:"px-3 py-2 text-sm text-gray-500",children:n?`No tactics available for ${n}`:"No tactics found"}):(n?g:c).filter(s=>{if(!p)return!0;const a=p.toLowerCase();return s.id.toLowerCase().includes(a)||s.name.toLowerCase().includes(a)}).map(s=>e.jsxs("div",{onClick:()=>{t(s.id),_(""),o(!1)},className:"px-3 py-2 cursor-pointer hover:bg-blue-50 border-b border-gray-100",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900",children:s.id}),e.jsx("div",{className:"text-xs text-gray-600",children:s.name})]},s.id))})]})]})]})]}),n&&h&&!w&&e.jsx("div",{className:"p-3 bg-amber-50 border border-amber-200 rounded-md",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-amber-600",children:"⚠"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"text-sm font-medium text-amber-900",children:"Invalid Combination"}),e.jsxs("div",{className:"text-xs text-amber-700 mt-1",children:["According to MITRE ATT&CK data, technique ",n," is not associated with tactic ",h,".",N&&N.tactics&&N.tactics.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("br",{}),"Valid tactics for this technique: ",N.tactics.join(", ")]})]})]})]})}),n&&h&&w&&e.jsx("div",{className:"p-3 bg-green-50 border border-green-200 rounded-md",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-green-600",children:"✓"}),e.jsx("div",{className:"text-sm text-green-900",children:"Valid technique-tactic combination"})]})})]})},Q=["text_short","text_long","textarea","number","single_select","multi_select","boolean","datetime","datetime_range","cve","cve_input","internet_asset","file_upload","scale"],F=["general","vulnerability_exploitation","data_theft","social_engineering","malware_deployment","lateral_movement","persistence_mechanism","privilege_escalation","defense_evasion","credential_access","discovery","collection","exfiltration","command_and_control","impact","active_scanning"],V=({question:n,onUpdate:h,onCancel:i,onDelete:b})=>{const[t,r]=m.useState({...n}),x=(o,f)=>{r({...t,[o]:f})},l=()=>{h(t),i()},j=()=>{const o={id:`${t.id}_sub_${Date.now()}`,type:"text_short",question:"New sub-question",required:!1,evidence_type:t.evidence_type,show_when:{parent_answer:""}},f={...t,sub_questions:[...t.sub_questions||[],o]};r(f)},p=(o,f)=>{const v=[...t.sub_questions||[]];v[o]=f,r({...t,sub_questions:v})},_=o=>{const f=[...t.sub_questions||[]];f.splice(o,1),r({...t,sub_questions:f})},S=t.type==="single_select"||t.type==="multi_select"||t.type==="scale";return e.jsxs("div",{className:"space-y-4 p-4 bg-white",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Question ID ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"text",value:t.id,onChange:o=>x("id",o.target.value),className:"w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"e.g., t1190_exploit_cves_used"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Question Text ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("textarea",{value:t.question,onChange:o=>x("question",o.target.value),rows:2,className:"w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"What information are you collecting?"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Question Type ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("select",{value:t.type,onChange:o=>x("type",o.target.value),className:"w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",children:Q.map(o=>e.jsx("option",{value:o,children:o},o))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Evidence Type"}),e.jsx("select",{value:t.evidence_type||"general",onChange:o=>x("evidence_type",o.target.value),className:"w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",children:F.map(o=>e.jsx("option",{value:o,children:o},o))})]})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",id:`required-${t.id}`,checked:t.required||!1,onChange:o=>x("required",o.target.checked),className:"h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"}),e.jsx("label",{htmlFor:`required-${t.id}`,className:"ml-2 text-sm text-gray-700",children:"Required field"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Explanation / Help Text"}),e.jsx("textarea",{value:t.explanation||"",onChange:o=>x("explanation",o.target.value),rows:2,className:"w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"Provide additional context or instructions..."})]}),S&&e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Options ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx(O,{options:t.options||[],onChange:o=>x("options",o)})]}),e.jsxs("div",{className:"border-t pt-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Conditional Sub-questions"}),e.jsx("button",{onClick:j,className:"px-2 py-1 text-xs bg-gray-100 text-gray-700 rounded hover:bg-gray-200",children:"+ Add Sub-question"})]}),t.sub_questions&&t.sub_questions.length>0?e.jsx("div",{className:"space-y-3 pl-4 border-l-2 border-gray-200",children:t.sub_questions.map((o,f)=>e.jsxs("div",{className:"bg-gray-50 p-3 rounded border border-gray-200",children:[e.jsxs("div",{className:"flex items-start justify-between mb-2",children:[e.jsxs("div",{className:"text-xs font-medium text-gray-700",children:["Sub-question ",f+1]}),e.jsx("button",{onClick:()=>_(f),className:"text-xs text-red-600 hover:text-red-800",children:"Remove"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("input",{type:"text",value:o.question,onChange:v=>{const y={...o,question:v.target.value};p(f,y)},className:"w-full px-2 py-1 text-xs border border-gray-300 rounded",placeholder:"Sub-question text"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("select",{value:o.type,onChange:v=>{const y={...o,type:v.target.value};p(f,y)},className:"px-2 py-1 text-xs border border-gray-300 rounded",children:Q.map(v=>e.jsx("option",{value:v,children:v},v))}),e.jsx("input",{type:"text",value:o.show_when?.parent_answer||"",onChange:v=>{const y={...o,show_when:{parent_answer:v.target.value}};p(f,y)},className:"px-2 py-1 text-xs border border-gray-300 rounded",placeholder:"Parent answer trigger"})]}),e.jsxs("p",{className:"text-xs text-gray-500",children:['Shows when parent answer is: "',o.show_when?.parent_answer||"(not set)",'"']})]})]},o.id||f))}):e.jsx("p",{className:"text-xs text-gray-500 pl-4",children:"No sub-questions. Add one to show questions conditionally based on the answer to this question."})]}),e.jsxs("div",{className:"flex gap-2 pt-4 border-t",children:[e.jsx("button",{onClick:l,className:"flex-1 px-3 py-2 text-sm bg-blue-600 text-white rounded hover:bg-blue-700",children:"Save Question"}),e.jsx("button",{onClick:i,className:"px-3 py-2 text-sm bg-gray-100 text-gray-700 rounded hover:bg-gray-200",children:"Cancel"}),e.jsx("button",{onClick:b,className:"px-3 py-2 text-sm bg-red-100 text-red-700 rounded hover:bg-red-200",children:"Delete"})]})]})},P=({group:n,mitreData:h,onUpdate:i,onDelete:b})=>{const[t,r]=m.useState(null),[x,l]=m.useState(!1),[j,p]=m.useState(null);if(m.useEffect(()=>{r(n?JSON.parse(JSON.stringify(n)):null),l(!1),p(null)},[n]),!t)return e.jsx("div",{className:"flex items-center justify-center h-full text-gray-500",children:e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-lg mb-2",children:"No question group selected"}),e.jsx("p",{className:"text-sm",children:"Select a group from the browser or create a new one"})]})});const _=(d,s)=>{r({...t,[d]:s}),l(!0)},S=d=>{const s={...t,technique_id:d};s.show_when&&s.show_when.technique_tactic_combinations&&(s.show_when.technique_tactic_combinations=[{technique_id:d,tactic_id:s.tactic_id}]),r(s),l(!0)},o=d=>{const s={...t,tactic_id:d};s.show_when&&s.show_when.technique_tactic_combinations&&(s.show_when.technique_tactic_combinations=[{technique_id:s.technique_id,tactic_id:d}]),r(s),l(!0)},f=()=>{i(t),l(!1)},v=()=>{r(n?JSON.parse(JSON.stringify(n)):null),l(!1)},y=()=>{const d={...t,id:`${t.id}_copy_${Date.now()}`};i(d)},c=()=>{const d={id:`question_${Date.now()}`,type:"text_short",question:"New question",required:!1,evidence_type:"general"},s={...t,question_flow:[...t.question_flow||[],d]};r(s),l(!0),p((t.question_flow||[]).length)},g=(d,s)=>{const a=[...t.question_flow||[]];a[d]=s,r({...t,question_flow:a}),l(!0)},w=d=>{if(!confirm("Are you sure you want to delete this question?"))return;const a=[...t.question_flow||[]];a.splice(d,1),r({...t,question_flow:a}),l(!0),p(null)},N=(d,s)=>{const a=[...t.question_flow||[]],u=s==="up"?d-1:d+1;u<0||u>=a.length||([a[d],a[u]]=[a[u],a[d]],r({...t,question_flow:a}),l(!0),p(u))};return e.jsx("div",{className:"max-w-6xl mx-auto",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6 pb-4 border-b border-gray-200",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-gray-900",children:"Edit Question Group"}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:"Define technique-specific evidence collection questions"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:y,className:"px-3 py-1.5 text-sm bg-gray-100 text-gray-700 rounded hover:bg-gray-200",title:"Duplicate this group",children:"Duplicate"}),e.jsx("button",{onClick:b,className:"px-3 py-1.5 text-sm bg-red-100 text-red-700 rounded hover:bg-red-200",children:"Delete Group"})]})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Group ID ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"text",value:t.id,onChange:d=>_("id",d.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"e.g., initial_access_t1190_analysis"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Unique identifier for this question group"})]}),e.jsx(U,{techniqueId:t.technique_id,tacticId:t.tactic_id,mitreData:h,onTechniqueChange:S,onTacticChange:o}),e.jsxs("div",{className:"border-t pt-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Questions"}),e.jsx("button",{onClick:c,className:"px-3 py-1.5 text-sm bg-blue-600 text-white rounded hover:bg-blue-700",children:"+ Add Question"})]}),t.question_flow&&t.question_flow.length>0?e.jsx("div",{className:"space-y-3",children:t.question_flow.map((d,s)=>e.jsx("div",{className:`border rounded-lg p-4 ${j===s?"border-blue-500 bg-blue-50":"border-gray-200 hover:border-gray-300"}`,children:j===s?e.jsx(V,{question:d,onUpdate:a=>g(s,a),onCancel:()=>p(null),onDelete:()=>w(s)}):e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1 cursor-pointer",onClick:()=>p(s),children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsxs("span",{className:"text-xs font-medium text-gray-500",children:["#",s+1]}),e.jsx("span",{className:"text-xs px-2 py-0.5 bg-gray-100 text-gray-700 rounded",children:d.type}),d.required&&e.jsx("span",{className:"text-xs px-2 py-0.5 bg-red-100 text-red-700 rounded",children:"Required"})]}),e.jsx("div",{className:"text-sm text-gray-900 font-medium",children:d.question||"Untitled question"}),e.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:["ID: ",d.id]}),d.sub_questions&&d.sub_questions.length>0&&e.jsxs("div",{className:"text-xs text-blue-600 mt-1",children:[d.sub_questions.length," sub-question",d.sub_questions.length!==1?"s":""]})]}),e.jsxs("div",{className:"flex items-center gap-1 ml-4",children:[e.jsx("button",{onClick:()=>N(s,"up"),disabled:s===0,className:"px-2 py-1 text-sm text-gray-600 hover:text-gray-900 disabled:opacity-30 disabled:cursor-not-allowed",title:"Move up",children:"↑"}),e.jsx("button",{onClick:()=>N(s,"down"),disabled:s===t.question_flow.length-1,className:"px-2 py-1 text-sm text-gray-600 hover:text-gray-900 disabled:opacity-30 disabled:cursor-not-allowed",title:"Move down",children:"↓"}),e.jsx("button",{onClick:()=>p(s),className:"px-2 py-1 text-sm text-blue-600 hover:text-blue-800",title:"Edit",children:"Edit"})]})]})},d.id||s))}):e.jsxs("div",{className:"text-center py-8 bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg",children:[e.jsx("p",{className:"text-gray-500 mb-2",children:"No questions yet"}),e.jsx("button",{onClick:c,className:"px-4 py-2 text-sm bg-blue-600 text-white rounded hover:bg-blue-700",children:"Add First Question"})]})]})]}),e.jsxs("div",{className:"flex gap-3 mt-8 pt-6 border-t border-gray-200",children:[e.jsx("button",{onClick:f,disabled:!x,className:`flex-1 px-4 py-2 rounded font-medium ${x?"bg-blue-600 text-white hover:bg-blue-700":"bg-gray-200 text-gray-500 cursor-not-allowed"}`,children:"Save Changes"}),x&&e.jsx("button",{onClick:v,className:"px-4 py-2 bg-gray-100 text-gray-700 rounded hover:bg-gray-200",children:"Cancel"})]})]})})},B=({errors:n,onGroupClick:h})=>{if(n.length===0)return e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-green-600 text-xl",children:"✓"}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-semibold text-green-900",children:"Configuration Valid"}),e.jsx("p",{className:"text-xs text-green-700 mt-1",children:"No validation errors or warnings found. Your Phase 4 configuration is ready to use."})]})]})});const i=n.filter(t=>t.type==="error").length,b=n.filter(t=>t.type==="warning").length;return e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:`border rounded-lg p-4 ${i>0?"bg-red-50 border-red-200":"bg-amber-50 border-amber-200"}`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:`text-xl ${i>0?"text-red-600":"text-amber-600"}`,children:i>0?"❌":"⚠"}),e.jsxs("div",{children:[e.jsx("h3",{className:`text-sm font-semibold ${i>0?"text-red-900":"text-amber-900"}`,children:"Validation Issues Found"}),e.jsxs("p",{className:`text-xs mt-1 ${i>0?"text-red-700":"text-amber-700"}`,children:[i>0&&`${i} error${i!==1?"s":""}`,i>0&&b>0&&", ",b>0&&`${b} warning${b!==1?"s":""}`]})]})]})}),e.jsx("div",{className:"max-h-64 overflow-y-auto border border-gray-200 rounded-lg",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50 sticky top-0",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Type"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Location"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Message"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Path"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:n.map((t,r)=>e.jsxs("tr",{className:`hover:bg-gray-50 ${t.groupIndex!==void 0?"cursor-pointer":""}`,onClick:()=>{t.groupIndex!==void 0&&h(t.groupIndex)},children:[e.jsx("td",{className:"px-3 py-2 whitespace-nowrap",children:e.jsx("span",{className:`inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${t.type==="error"?"bg-red-100 text-red-800":"bg-amber-100 text-amber-800"}`,children:t.type==="error"?"Error":"Warning"})}),e.jsx("td",{className:"px-3 py-2 text-xs text-gray-900",children:t.groupIndex!==void 0&&e.jsxs("div",{children:["Group #",t.groupIndex,t.groupId&&e.jsx("div",{className:"text-gray-500",children:t.groupId}),t.questionId&&e.jsxs("div",{className:"text-gray-500",children:["Q: ",t.questionId]})]})}),e.jsx("td",{className:"px-3 py-2 text-xs text-gray-900",children:t.message}),e.jsx("td",{className:"px-3 py-2 text-xs text-gray-500 font-mono",children:t.path})]},r))})]})})]})};function T(n){return n.some(h=>h.type==="error")}function E(n,h){const i=[];if(!n.question_groups||!Array.isArray(n.question_groups))return i.push({type:"error",message:"Configuration must have a question_groups array",path:"question_groups"}),i;const b=new Map;return n.question_groups.forEach((t,r)=>{const x=`question_groups[${r}]`;if(t.id||i.push({type:"error",groupIndex:r,message:"Question group must have an id",path:`${x}.id`}),t.technique_id||i.push({type:"error",groupIndex:r,groupId:t.id,message:"Question group must have a technique_id",path:`${x}.technique_id`}),t.tactic_id||i.push({type:"error",groupIndex:r,groupId:t.id,message:"Question group must have a tactic_id",path:`${x}.tactic_id`}),t.technique_id&&!h.techniques[t.technique_id]&&i.push({type:"error",groupIndex:r,groupId:t.id,message:`Technique ${t.technique_id} not found in MITRE ATT&CK data`,path:`${x}.technique_id`}),t.tactic_id&&!h.tactics[t.tactic_id]&&i.push({type:"error",groupIndex:r,groupId:t.id,message:`Tactic ${t.tactic_id} not found in MITRE ATT&CK data`,path:`${x}.tactic_id`}),t.technique_id&&t.tactic_id){const l=h.techniques[t.technique_id];l&&!l.tactics?.includes(t.tactic_id)&&i.push({type:"warning",groupIndex:r,groupId:t.id,message:`Technique ${t.technique_id} may not be valid for tactic ${t.tactic_id} according to MITRE data`,path:`${x}.technique_id + tactic_id`})}if(t.technique_id&&t.tactic_id){const l=`${t.technique_id}:${t.tactic_id}`,j=b.get(l)||[];j.push(r),b.set(l,j)}if(t.show_when&&(!t.show_when.technique_tactic_combinations||!Array.isArray(t.show_when.technique_tactic_combinations)?i.push({type:"error",groupIndex:r,groupId:t.id,message:"show_when must have technique_tactic_combinations array",path:`${x}.show_when.technique_tactic_combinations`}):t.show_when.technique_tactic_combinations.forEach((l,j)=>{(!l.technique_id||!l.tactic_id)&&i.push({type:"error",groupIndex:r,groupId:t.id,message:`Combination ${j} must have both technique_id and tactic_id`,path:`${x}.show_when.technique_tactic_combinations[${j}]`})})),!t.question_flow||!Array.isArray(t.question_flow))i.push({type:"error",groupIndex:r,groupId:t.id,message:"Question group must have a question_flow array",path:`${x}.question_flow`});else if(t.question_flow.length===0)i.push({type:"warning",groupIndex:r,groupId:t.id,message:"Question group has no questions",path:`${x}.question_flow`});else{const l=new Set;t.question_flow.forEach((j,p)=>{A(j,l,i,r,t.id,`${x}.question_flow[${p}]`)})}}),b.forEach((t,r)=>{t.length>1&&i.push({type:"warning",message:`Duplicate technique-tactic combination ${r} found in groups: ${t.join(", ")}`,path:"question_groups"})}),i}function A(n,h,i,b,t,r){n.id?(h.has(n.id)&&i.push({type:"error",groupIndex:b,groupId:t,questionId:n.id,message:`Duplicate question id: ${n.id}`,path:`${r}.id`}),h.add(n.id)):i.push({type:"error",groupIndex:b,groupId:t,message:"Question must have an id",path:`${r}.id`}),n.question||i.push({type:"error",groupIndex:b,groupId:t,questionId:n.id,message:"Question must have question text",path:`${r}.question`}),n.type||i.push({type:"error",groupIndex:b,groupId:t,questionId:n.id,message:"Question must have a type",path:`${r}.type`}),["single_select","multi_select","scale"].includes(n.type)&&(!n.options||n.options.length===0)&&i.push({type:"error",groupIndex:b,groupId:t,questionId:n.id,message:`Question type ${n.type} requires options`,path:`${r}.options`}),n.sub_questions&&Array.isArray(n.sub_questions)&&n.sub_questions.forEach((l,j)=>{A(l,h,i,b,t,`${r}.sub_questions[${j}]`),(!l.show_when||!l.show_when.parent_answer)&&i.push({type:"warning",groupIndex:b,groupId:t,questionId:l.id,message:"Sub-question should have show_when.parent_answer defined",path:`${r}.sub_questions[${j}].show_when`})})}const J=()=>{const[n,h]=m.useState(null),[i,b]=m.useState(null),[t,r]=m.useState(null),[x,l]=m.useState(null),[j,p]=m.useState(!0),[_,S]=m.useState(null),[o,f]=m.useState([]),[v,y]=m.useState(!1);m.useEffect(()=>{(async()=>{try{const u="/data/phase4-config.json",q="/ikb-demo/",k=(q.endsWith("/")?q.slice(0,-1):q)+u,$=await fetch(k);if(!$.ok)throw new Error(`Failed to load Phase 4 configuration: ${$.status}`);const M=await $.json();h(M);const G=await D.loadMitreDataAsync();b(G),p(!1)}catch(u){S(u instanceof Error?u.message:"Unknown error"),p(!1)}})()},[]),m.useEffect(()=>{if(n&&i){const a=E(n,i);f(a)}},[n,i]);const c=(a,u)=>{r(a),l(u)},g=a=>{if(!n||x===null)return;const u={...n};u.question_groups[x]=a,h(u),r(a)},w=a=>{if(!n)return;const u={...n};u.question_groups.push(a),h(u),r(a),l(u.question_groups.length-1)},N=()=>{if(!n||x===null||!t||!confirm(`Are you sure you want to delete the question group for ${t.technique_id} in ${t.tactic_id}?`))return;const u={...n};u.question_groups.splice(x,1),h(u),r(null),l(null)},d=()=>{if(!n||!i)return;const a=E(n,i);if(f(a),T(a)){y(!0),alert("Cannot export: Please fix all errors before downloading the configuration.");return}if(a.length>0&&!confirm(`There are ${a.length} warning(s) in your configuration. Do you want to continue with the download?`)){y(!0);return}const u=new Blob([JSON.stringify(n,null,2)],{type:"application/json"}),q=URL.createObjectURL(u),C=document.createElement("a");C.href=q,C.download="phase4-config.json",document.body.appendChild(C),C.click(),document.body.removeChild(C),URL.revokeObjectURL(q)},s=async a=>{try{const u=await a.text(),q=JSON.parse(u);if(!i){alert("MITRE data not loaded yet. Please wait and try again.");return}const C=E(q,i);if(f(C),T(C)&&!confirm(`The imported configuration has ${C.filter($=>$.type==="error").length} error(s). Import anyway?`)){y(!0);return}h(q),r(null),l(null),y(!0)}catch(u){alert("Failed to import configuration: "+(u instanceof Error?u.message:"Unknown error"))}};return j?e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"Loading Phase 4 configuration and MITRE ATT&CK data..."})]})}):_?e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsxs("p",{className:"text-red-600 mb-4",children:["Error: ",_]}),e.jsx("button",{onClick:()=>window.location.reload(),className:"px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700",children:"Retry"})]})}):e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[e.jsx("header",{className:"bg-white shadow-sm border-b border-gray-200",children:e.jsx("div",{className:"max-w-full mx-auto px-4 py-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Phase 4 Question Editor"}),e.jsxs("p",{className:"text-sm text-gray-600 mt-1",children:["Technique-Specific Evidence Collection Questions",n&&e.jsxs("span",{className:"ml-2 text-blue-600",children:["(",n.question_groups.length," question groups)"]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{onClick:()=>y(!v),className:`px-4 py-2 rounded border ${T(o)?"bg-red-50 text-red-700 border-red-300":o.length>0?"bg-amber-50 text-amber-700 border-amber-300":"bg-green-50 text-green-700 border-green-300"}`,children:T(o)?e.jsxs("span",{children:["❌ ",o.filter(a=>a.type==="error").length," Errors"]}):o.length>0?e.jsxs("span",{children:["⚠ ",o.length," Warnings"]}):e.jsx("span",{children:"✓ Valid"})}),e.jsxs("label",{className:"px-4 py-2 bg-white text-blue-600 border border-blue-600 rounded hover:bg-blue-50 cursor-pointer",children:["Import Config",e.jsx("input",{type:"file",accept:".json",className:"hidden",onChange:a=>{const u=a.target.files?.[0];u&&s(u)}})]}),e.jsx("button",{onClick:d,className:"px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700",children:"Download Configuration"})]})]})})}),v&&e.jsx("div",{className:"bg-gray-100 border-b border-gray-200 p-4",children:e.jsx("div",{className:"max-w-full mx-auto",children:e.jsx(B,{errors:o,onGroupClick:a=>{const u=n?.question_groups[a];u&&(c(u,a),y(!1))}})})}),e.jsxs("div",{className:"flex h-[calc(100vh-88px)]",children:[e.jsx("div",{className:"w-1/3 bg-white border-r border-gray-200 overflow-y-auto",children:e.jsx(R,{config:n,mitreData:i,selectedGroup:t,onGroupSelect:c,onGroupAdd:w})}),e.jsx("div",{className:"w-2/3 overflow-y-auto p-6",children:e.jsx(P,{group:t,config:n,mitreData:i,onUpdate:g,onDelete:N})})]})]})};L.createRoot(document.getElementById("phase4-editor-root")).render(e.jsx(m.StrictMode,{children:e.jsx(J,{})}));
